// Dữ liệu vaccine theo lịch tiêm chủng mở rộng (bắt buộc)
const mandatoryVaccines = [
    { age: 0, name: "BCG", disease: "Lao", dose: "Mũi 1", type: "mandatory" },
    { age: 0, name: "Viêm gan B sơ sinh", disease: "Viêm gan B", dose: "Mũi 1", maxAgeDays: 7, note: "Chỉ tiêm trong vòng 7 ngày sau sinh", type: "mandatory" },
    { age: 2, name: "SII", disease: "Bạch hầu, Ho gà, Uốn ván, Viêm gan B, Hib", dose: "Mũi 1", type: "mandatory" },
    { age: 2, name: "OPV", disease: "Bại liệt", dose: "Mũi 1", type: "mandatory" },
    { age: 2, name: "Rota", disease: "Tiêu chảy do Rota virus", dose: "Mũi 1", type: "mandatory" },
    { age: 3, name: "SII", disease: "Bạch hầu, Ho gà, Uốn ván, Viêm gan B, Hib", dose: "Mũi 2", type: "mandatory" },
    { age: 3, name: "OPV", disease: "Bại liệt", dose: "Mũi 2", type: "mandatory" },
    { age: 3, name: "Rota", disease: "Tiêu chảy do Rota virus", dose: "Mũi 2", type: "mandatory" },
    { age: 4, name: "SII", disease: "Bạch hầu, Ho gà, Uốn ván, Viêm gan B, Hib", dose: "Mũi 3", type: "mandatory" },
    { age: 4, name: "OPV", disease: "Bại liệt", dose: "Mũi 3", type: "mandatory" },
    { age: 5, name: "IPV", disease: "Bại liệt", dose: "Mũi bổ sung 1", type: "mandatory" },
    { age: 9, name: "IPV", disease: "Bại liệt", dose: "Mũi bổ sung 2", type: "mandatory" },
    { age: 9, name: "Sởi", disease: "Sởi", dose: "Mũi 1", type: "mandatory" },
    { age: 12, name: "Viêm não Nhật Bản", disease: "Viêm não Nhật Bản", dose: "Mũi 1", type: "mandatory" },
    { daysAfterPrevious: 7, prevVaccine: "Viêm não Nhật Bản", prevDose: "Mũi 1", name: "Viêm não Nhật Bản", disease: "Viêm não Nhật Bản", dose: "Mũi 2", isRelativeTiming: true, displayAge: "12 tháng", type: "mandatory" },
    { age: 18, name: "DPT", disease: "Bạch hầu, Ho gà, Uốn ván", dose: "Mũi 4", type: "mandatory" },
    { age: 18, name: "Sởi-Rubella", disease: "Sởi, Rubella", dose: "Mũi 1", type: "mandatory" },
    { age: 24, name: "Viêm não Nhật Bản", disease: "Viêm não Nhật Bản", dose: "Mũi 3", type: "mandatory" },
    { age: 84, name: "Td", disease: "Uốn ván - Bạch hầu", dose: "Nhắc lại lần 1", note: "7 tuổi", type: "mandatory" }
];

// Dữ liệu vaccine tự nguyện phổ biến (có phí)
const optionalVaccines = [
    { age: 2, name: "PCV", disease: "Phế cầu khuẩn", dose: "Mũi 1", type: "optional" },
    { age: 4, name: "PCV", disease: "Phế cầu khuẩn", dose: "Mũi 2", type: "optional" },
    { age: 12, name: "PCV", disease: "Phế cầu khuẩn", dose: "Mũi 3", type: "optional" },
    { age: 12, name: "MMR", disease: "Sởi - Quai bị - Rubella", dose: "Mũi 1", type: "optional" },
    { age: 18, name: "MMR", disease: "Sởi - Quai bị - Rubella", dose: "Mũi 2", type: "optional" },
    { age: 12, name: "Thủy đậu", disease: "Thủy đậu", dose: "Mũi 1", type: "optional" },
    { age: 12, name: "Viêm gan A", disease: "Viêm gan A", dose: "Mũi 1", type: "optional" },
    { age: 18, name: "Viêm gan A", disease: "Viêm gan A", dose: "Mũi 2", type: "optional", note: "Cách mũi 1 ít nhất 6 tháng" },
    { age: 12, name: "Cúm", disease: "Cúm", dose: "Hàng năm", type: "optional", note: "Tiêm nhắc hàng năm" },
    { age: 9, name: "Não mô cầu AC/ACYW", disease: "Viêm màng não mô cầu", dose: "Mũi 1", type: "optional" },
    { age: 12, name: "Typhoid", disease: "Thương hàn", dose: "Mũi 1", type: "optional", note: "Nhắc lại sau 3 năm" },
    { age: 12, name: "HPV", disease: "Virus gây u nhú ở người (ngừa ung thư cổ tử cung)", dose: "Mũi 1", gender: "female", type: "optional", note: "Tiêm cho bé gái" },
    { age: 13.5, name: "HPV", disease: "Virus gây u nhú ở người (ngừa ung thư cổ tử cung)", dose: "Mũi 2", gender: "female", type: "optional", note: "Cách mũi 1 ít nhất 6 tháng" },
    { age: 12, name: "DENV", disease: "Sốt xuất huyết Dengue", dose: "Mũi 1", type: "optional" },
    { age: 18, name: "DENV", disease: "Sốt xuất huyết Dengue", dose: "Mũi 2", type: "optional", note: "Cách mũi 1 ít nhất 6 tháng" },
    { age: 24, name: "DENV", disease: "Sốt xuất huyết Dengue", dose: "Mũi 3", type: "optional", note: "Cách mũi 2 ít nhất 6 tháng" },
    { age: 12, name: "Tả", disease: "Bệnh tả", dose: "Mũi 1", type: "optional", note: "Nhắc lại sau 2 năm" }
];

// Kết hợp cả hai loại vaccine
let vaccineSchedule = [...mandatoryVaccines];

// Cập nhật HTML cho phần lựa chọn loại vắc xin
document.querySelector('.container').insertAdjacentHTML('afterbegin', `
    <div class="form-group" style="margin-top: 20px;">
        <label>Hiển thị vắc xin:</label>
        <div>
            <input type="checkbox" id="showMandatory" name="vaccineType" value="mandatory" checked>
            <label for="showMandatory" style="display: inline;">Chương trình TCMR (miễn phí)</label>
            
            <input type="checkbox" id="showOptional" name="vaccineType" value="optional" checked style="margin-left: 20px;">
            <label for="showOptional" style="display: inline;">Tự nguyện (có phí)</label>
        </div>
    </div>
`);

// Bổ sung CSS để phân biệt loại vắc xin
const styleElement = document.createElement('style');
styleElement.textContent = `
    .vaccine-mandatory {
        border-left: 4px solid #bda0cf;
    }
    .vaccine-optional {
        border-left: 4px solid #95cfa9;
    }
    .vaccine-type-tag {
        display: inline-block;
        padding: 2px 6px;
        font-size: 0.7em;
        border-radius: 4px;
        margin-left: 6px;
        font-weight: bold;
    }
    .tag-mandatory {
        background-color: #e9ddff;
        color: #6d6a8c;
    }
    .tag-optional {
        background-color: #e2f5e6;
        color: #4a7d5a;
    }
    th.vaccine-type {
        width: 100px;
    }
`;
document.head.appendChild(styleElement);

// Cập nhật bảng để thêm cột loại vắc xin
document.querySelector('#scheduleTable thead tr').innerHTML = `
    <th>Độ tuổi</th>
    <th>Vaccine</th>
    <th>Loại</th>
    <th>Ngày tiêm</th>
    <th>Trạng thái</th>
`;

// Cập nhật sự kiện cho các checkbox
document.getElementById('showMandatory').addEventListener('change', updateVaccineList);
document.getElementById('showOptional').addEventListener('change', updateVaccineList);

// Hàm cập nhật danh sách vaccine dựa trên lựa chọn
function updateVaccineList() {
    const showMandatory = document.getElementById('showMandatory').checked;
    const showOptional = document.getElementById('showOptional').checked;
    
    vaccineSchedule = [];
    
    if (showMandatory) {
        vaccineSchedule = [...vaccineSchedule, ...mandatoryVaccines];
    }
    
    if (showOptional) {
        vaccineSchedule = [...vaccineSchedule, ...optionalVaccines];
    }
    
    // Nếu đã nhập ngày sinh, tính lại lịch tiêm
    const birthdate = new Date(birthdateInput.value);
    if (!isNaN(birthdate.getTime())) {
        calculateBtn.click();
    }
}

// Cập nhật hàm tính toán để hiển thị loại vắc xin
calculateBtn.addEventListener('click', function() {
    // [Giữ nguyên mã hiện tại]
    
    // Cập nhật phần tạo hàng trong bảng
    vaccinesForAge.forEach(vaccine => {
        const row = document.createElement('tr');
        row.className = `vaccine-${vaccine.type}`;
        
        // [Phần còn lại giữ nguyên]
        
        // Cột loại vắc xin
        const typeCell = document.createElement('td');
        if (vaccine.type === 'mandatory') {
            typeCell.innerHTML = `<span class="vaccine-type-tag tag-mandatory">Bắt buộc</span>`;
        } else {
            typeCell.innerHTML = `<span class="vaccine-type-tag tag-optional">Tự nguyện</span>`;
        }
        row.appendChild(typeCell);
        
        // [Phần còn lại giữ nguyên]
    });
});

// Cập nhật hàm thêm mũi tiêm trước đó để bao gồm cả vắc xin tự nguyện
addPreviousBtn.addEventListener('click', function() {
    // [Phần đầu giữ nguyên]
    
    // Tạo dropdown chọn vaccine bao gồm cả bắt buộc và tự nguyện
    const vaccineSelect = document.createElement('select');
    vaccineSelect.className = 'previous-vaccine-name';
    
    // Kết hợp cả hai danh sách
    const allVaccines = [...mandatoryVaccines, ...optionalVaccines];
    const uniqueVaccines = [...new Set(allVaccines.map(v => v.name))];
    uniqueVaccines.sort().forEach(vaccine => {
        const option = document.createElement('option');
        option.value = vaccine;
        option.textContent = vaccine;
        vaccineSelect.appendChild(option);
    });
    
    // [Phần còn lại giữ nguyên]
});

// Bổ sung vào hàm updateDoseOptions để tìm liều lượng trong cả hai danh sách vắc xin
function updateDoseOptions(vaccineSelect, doseSelect) {
    const selectedVaccine = vaccineSelect.value;
    
    // Lọc các liều duy nhất cho vaccine đã chọn từ cả hai danh sách
    const allVaccines = [...mandatoryVaccines, ...optionalVaccines];
    const doses = allVaccines
        .filter(v => v.name === selectedVaccine)
        .map(v => v.dose);
    
    // [Phần còn lại giữ nguyên]
}

// Khởi tạo danh sách vaccine
updateVaccineList();
<!-- Thêm phần giải thích về vắc xin vào phần kết quả -->
<div style="margin-top: 30px; background-color: #f8f2ff; padding: 20px; border-radius: 8px; border-left: 4px solid #c9abda;">
    <h3 style="color: #9c7aa5; margin-top: 0;">Thông tin về các loại vắc xin</h3>
    
    <div style="margin-bottom: 15px;">
        <h4 style="color: #7c668d; margin-bottom: 5px;">Vắc xin trong chương trình tiêm chủng mở rộng <span class="vaccine-type-tag tag-mandatory">Bắt buộc</span></h4>
        <p>Đây là các loại vắc xin được Bộ Y tế Việt Nam triển khai miễn phí cho tất cả trẻ em theo chương trình tiêm chủng mở rộng quốc gia. Tiêm chủng các loại vắc xin này giúp phòng ngừa các bệnh truyền nhiễm nguy hiểm và được khuyến cáo tiêm đầy đủ cho mọi trẻ em.</p>
    </div>
    
    <div>
        <h4 style="color: #4a7d5a; margin-bottom: 5px;">Vắc xin tự nguyện <span class="vaccine-type-tag tag-optional">Tự nguyện</span></h4>
        <p>Đây là các loại vắc xin ngoài chương trình tiêm chủng mở rộng. Phụ huynh có thể lựa chọn tiêm cho con tại các cơ sở tiêm chủng dịch vụ với chi phí tự chi trả. Các vắc xin này cũng rất quan trọng trong việc phòng ngừa nhiều bệnh truyền nhiễm.</p>
        <p><strong>Lưu ý:</strong> Giá tiền cho mỗi loại vắc xin tự nguyện có thể dao động từ vài trăm nghìn đến vài triệu đồng tùy loại và nơi tiêm. Nên tham khảo ý kiến bác sĩ để lựa chọn phù hợp với điều kiện gia đình và nhu cầu bảo vệ sức khỏe của bé.</p>
    </div>
</div>
