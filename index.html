<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch tiêm</title>
    <style>
        body {
            font-family: Segoe UI, sans-serif;
            background-color: #fef6f9;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: #fffafc;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .container {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        #results {
            margin-top: 30px;
            display: none;
        }
        .schedule-item {
            background-color: white;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
            border-radius: 4px;
        }
        .due {
            border-left-color: #e74c3c;
        }
        .coming {
            border-left-color: #f39c12;
        }
        .complete {
            border-left-color: #2ecc71;
        }
        .vaccine-date {
            font-weight: bold;
        }
        .vaccine-info {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .status-due {
            color: #e74c3c;
            font-weight: bold;
        }
        .status-coming {
            color: #f39c12;
        }
        .status-complete {
            color: #2ecc71;
        }
        #previousVaccines {
            margin-top: 15px;
            display: none;
        }
        .previous-vaccine {
            margin-bottom: 10px;
            background-color: #eef8ff;
            padding: 10px;
            border-radius: 5px;
        }
        .remove-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        #addPreviousBtn {
            background-color: #2ecc71;
            margin-bottom: 20px;
        }
        .tip {
            font-style: italic;
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .alert {
            color: #e74c3c;
            font-weight: bold;
            font-style: italic;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Công cụ nhắc lịch tiêm chủng cho trẻ</h1>
        
        <div class="form-group">
            <label for="birthdate">Ngày sinh của trẻ:</label>
            <input type="date" id="birthdate" required>
            <p class="tip">Nhập chính xác ngày sinh để hệ thống tính toán lịch tiêm phù hợp</p>
        </div>
        
        <div class="form-group">
            <label>Đã tiêm các mũi vaccine trước đó?</label>
            <div>
                <input type="radio" id="hasVaccine" name="previousVaccine" value="yes">
                <label for="hasVaccine" style="display: inline;">Có</label>
                
                <input type="radio" id="noVaccine" name="previousVaccine" value="no" checked style="margin-left: 20px;">
                <label for="noVaccine" style="display: inline;">Chưa</label>
            </div>
        </div>
        
        <div id="previousVaccines">
            <button type="button" id="addPreviousBtn">+ Thêm mũi tiêm đã thực hiện</button>
            
            <div id="previousVaccinesList"></div>
        </div>
        
        <div class="form-group">
            <label for="parentName">Họ tên phụ huynh:</label>
            <input type="text" id="parentName">
        </div>
        
        <div class="form-group">
            <label for="contactInfo">Thông tin liên hệ (Email hoặc SĐT):</label>
            <input type="text" id="contactInfo">
            <p class="tip">Hệ thống sẽ gửi nhắc nhở khi đến lịch tiêm</p>
        </div>
        
        <button type="button" id="calculateBtn">Tạo lịch tiêm chủng</button>
        
        <div id="results">
            <h2>Lịch tiêm chủng cho bé</h2>
            <p id="childInfo"></p>
            
            <table id="scheduleTable">
                <thead>
                    <tr>
                        <th>Độ tuổi</th>
                        <th>Vaccine</th>
                        <th>Ngày tiêm</th>
                        <th>Trạng thái</th>
                    </tr>
                </thead>
                <tbody id="scheduleBody"></tbody>
            </table>
            
            <div style="margin-top: 20px; font-size: 0.9em;">
                <p><strong>Chú ý:</strong> Lịch tiêm này được tạo dựa trên lịch tiêm chủng mở rộng theo Thông tư 10/TT-BYT ngày 13/6/2024 của Bộ Y tế. Vui lòng tham khảo ý kiến bác sĩ để có lịch tiêm phù hợp nhất cho trẻ.</p>
                <p>Cập nhật lần cuối: 04/2025</p>
            </div>
        </div>
    </div>

    <script>
        // Dữ liệu vaccine theo lịch tiêm chủng mở rộng (Đã cập nhật theo yêu cầu)
        const vaccineSchedule = [
            { age: 0, name: "BCG", disease: "Lao", dose: "Mũi 1" },
            { age: 0, name: "Viêm gan B sơ sinh", disease: "Viêm gan B", dose: "Mũi 1", maxAgeDays: 7, note: "Chỉ tiêm trong vòng 7 ngày sau sinh" },
            { age: 2, name: "SII", disease: "Bạch hầu, Ho gà, Uốn ván, Viêm gan B, Hib", dose: "Mũi 1" },
            { age: 2, name: "OPV", disease: "Bại liệt", dose: "Mũi 1" },
            { age: 2, name: "Rota", disease: "Tiêu chảy do Rota virus", dose: "Mũi 1" },
            { age: 3, name: "SII", disease: "Bạch hầu, Ho gà, Uốn ván, Viêm gan B, Hib", dose: "Mũi 2" },
            { age: 3, name: "OPV", disease: "Bại liệt", dose: "Mũi 2" },
            { age: 3, name: "Rota", disease: "Tiêu chảy do Rota virus", dose: "Mũi 2" },
            { age: 4, name: "SII", disease: "Bạch hầu, Ho gà, Uốn ván, Viêm gan B, Hib", dose: "Mũi 3" },
            { age: 4, name: "OPV", disease: "Bại liệt", dose: "Mũi 3" },
            { age: 5, name: "IPV", disease: "Bại liệt", dose: "Mũi bổ sung 1" },
            { age: 9, name: "IPV", disease: "Bại liệt", dose: "Mũi bổ sung 2" },
            { age: 9, name: "Sởi", disease: "Sởi", dose: "Mũi 1" },
            { age: 12, name: "Viêm não Nhật Bản", disease: "Viêm não Nhật Bản", dose: "Mũi 1" },
            { daysAfterPrevious: 7, prevVaccine: "Viêm não Nhật Bản", prevDose: "Mũi 1", name: "Viêm não Nhật Bản", disease: "Viêm não Nhật Bản", dose: "Mũi 2", isRelativeTiming: true, displayAge: "12 tháng" },
            { age: 18, name: "SII", disease: "Bạch hầu, Ho gà, Uốn ván, Viêm gan B, Hib", dose: "Mũi 4" },
            { age: 18, name: "Sởi-Rubella", disease: "Sởi, Rubella", dose: "Mũi 1" },
            { age: 24, name: "Viêm não Nhật Bản", disease: "Viêm não Nhật Bản", dose: "Mũi 3" },
            { age: 84, name: "Td", disease: "Uốn ván - Bạch hầu", dose: "Nhắc lại lần 1", note: "7 tuổi" }
        ];

        // Lấy tham chiếu tới các phần tử
        const birthdateInput = document.getElementById('birthdate');
        const hasVaccineRadio = document.getElementById('hasVaccine');
        const noVaccineRadio = document.getElementById('noVaccine');
        const previousVaccinesDiv = document.getElementById('previousVaccines');
        const previousVaccinesList = document.getElementById('previousVaccinesList');
        const addPreviousBtn = document.getElementById('addPreviousBtn');
        const calculateBtn = document.getElementById('calculateBtn');
        const resultsDiv = document.getElementById('results');
        const childInfoP = document.getElementById('childInfo');
        const scheduleBody = document.getElementById('scheduleBody');

        // Xử lý sự kiện khi chọn radio button
        hasVaccineRadio.addEventListener('change', function() {
            if (this.checked) {
                previousVaccinesDiv.style.display = 'block';
            }
        });

        noVaccineRadio.addEventListener('change', function() {
            if (this.checked) {
                previousVaccinesDiv.style.display = 'none';
                previousVaccinesList.innerHTML = '';
            }
        });

        // Thêm mũi tiêm trước đó
        addPreviousBtn.addEventListener('click', function() {
            const previousVaccineDiv = document.createElement('div');
            previousVaccineDiv.className = 'previous-vaccine';
            
            // Tạo dropdown chọn vaccine
            const vaccineSelect = document.createElement('select');
            vaccineSelect.className = 'previous-vaccine-name';
            
            // Thêm các option vaccine
            const uniqueVaccines = [...new Set(vaccineSchedule.map(v => v.name))];
            uniqueVaccines.forEach(vaccine => {
                const option = document.createElement('option');
                option.value = vaccine;
                option.textContent = vaccine;
                vaccineSelect.appendChild(option);
            });
            
            // Tạo input ngày tiêm
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.className = 'previous-vaccine-date';
            dateInput.style.margin = '0 10px';
            
            // Tạo nút xóa
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = 'Xóa';
            removeBtn.addEventListener('click', function() {
                previousVaccinesList.removeChild(previousVaccineDiv);
            });
            
            // Tạo dropdown cho liều lượng
            const doseSelect = document.createElement('select');
            doseSelect.className = 'previous-vaccine-dose';
            
            // Thêm các option mặc định cho liều lượng
            const defaultDoses = ["Mũi 1", "Mũi 2", "Mũi 3", "Mũi 4", "Mũi bổ sung 1", "Mũi bổ sung 2", "Nhắc lại lần 1"];
            defaultDoses.forEach(dose => {
                const option = document.createElement('option');
                option.value = dose;
                option.textContent = dose;
                doseSelect.appendChild(option);
            });
            
            // Thêm các phần tử vào div
            previousVaccineDiv.appendChild(document.createTextNode('Vaccine: '));
            previousVaccineDiv.appendChild(vaccineSelect);
            previousVaccineDiv.appendChild(document.createTextNode(' Liều: '));
            previousVaccineDiv.appendChild(doseSelect);
            previousVaccineDiv.appendChild(document.createTextNode(' Ngày tiêm: '));
            previousVaccineDiv.appendChild(dateInput);
            previousVaccineDiv.appendChild(removeBtn);
            
            // Thêm div vào danh sách
            previousVaccinesList.appendChild(previousVaccineDiv);
            
            // Cập nhật các liều lượng dựa trên vaccine được chọn
            vaccineSelect.addEventListener('change', function() {
                updateDoseOptions(vaccineSelect, doseSelect);
            });
            
            // Cập nhật ban đầu
            updateDoseOptions(vaccineSelect, doseSelect);
        });
        
        // Hàm cập nhật các liều lượng dựa trên vaccine được chọn
        function updateDoseOptions(vaccineSelect, doseSelect) {
            const selectedVaccine = vaccineSelect.value;
            
            // Lọc các liều duy nhất cho vaccine đã chọn
            const doses = vaccineSchedule
                .filter(v => v.name === selectedVaccine)
                .map(v => v.dose);
            
            // Xóa các option hiện tại
            doseSelect.innerHTML = '';
            
            // Thêm các option mới
            doses.forEach(dose => {
                const option = document.createElement('option');
                option.value = dose;
                option.textContent = dose;
                doseSelect.appendChild(option);
            });
            
            // Nếu không có liều nào, thêm các liều mặc định
            if (doses.length === 0) {
                const defaultDoses = ["Mũi 1", "Mũi 2", "Mũi 3", "Mũi 4", "Mũi bổ sung 1", "Mũi bổ sung 2", "Nhắc lại lần 1"];
                defaultDoses.forEach(dose => {
                    const option = document.createElement('option');
                    option.value = dose;
                    option.textContent = dose;
                    doseSelect.appendChild(option);
                });
            }
        }

        // Tính toán lịch tiêm chủng
        calculateBtn.addEventListener('click', function() {
            const birthdate = new Date(birthdateInput.value);
            
            if (isNaN(birthdate.getTime())) {
                alert('Vui lòng nhập ngày sinh hợp lệ!');
                return;
            }
            
            // Lấy thông tin các mũi tiêm trước đó
            const previousVaccines = [];
            if (hasVaccineRadio.checked) {
                const prevVaccineDivs = document.querySelectorAll('.previous-vaccine');
                prevVaccineDivs.forEach(div => {
                    const vaccineName = div.querySelector('.previous-vaccine-name').value;
                    const vaccineDose = div.querySelector('.previous-vaccine-dose').value;
                    const vaccineDate = div.querySelector('.previous-vaccine-date').value;
                    
                    if (vaccineDate) {
                        previousVaccines.push({
                            name: vaccineName,
                            dose: vaccineDose,
                            date: new Date(vaccineDate)
                        });
                    }
                });
            }
            
            // Tính tuổi hiện tại tính theo tháng
            const today = new Date();
            const ageInMonths = (today.getFullYear() - birthdate.getFullYear()) * 12 + 
                               (today.getMonth() - birthdate.getMonth());
            
            // Hiển thị thông tin trẻ
            childInfoP.textContent = `Trẻ sinh ngày ${birthdate.toLocaleDateString('vi-VN')} - Hiện ${ageInMonths} tháng tuổi`;
            
            // Xóa các hàng cũ trong bảng
            scheduleBody.innerHTML = '';
            
            // Tạo lịch tiêm chủng với xử lý cho vaccine phụ thuộc
            const processedVaccines = calculateVaccineDates(vaccineSchedule, birthdate, previousVaccines);
            
            // Hiển thị lịch tiêm
            processedVaccines.forEach(vaccine => {
                const row = document.createElement('tr');
                
                // Cột tuổi/thời gian
                const ageCell = document.createElement('td');
                if (vaccine.displayAge) {
                    ageCell.textContent = vaccine.displayAge;
                } else if (vaccine.age === 0) {
                    ageCell.textContent = 'Sơ sinh';
                } else if (vaccine.age === 24) {
                    ageCell.textContent = '24 tháng';
                } else if (vaccine.age === 12) {
                    ageCell.textContent = '12 tháng';
                } else if (vaccine.age >= 12 && vaccine.age % 12 === 0) {
                    const years = vaccine.age / 12;
                    ageCell.textContent = `${years} tuổi`;
                } else {
                    ageCell.textContent = `${vaccine.age} tháng`;
                }
                row.appendChild(ageCell);
                
                // Cột vaccine
                const vaccineCell = document.createElement('td');
                let vaccineInfo = `<strong>${vaccine.name}</strong><br><span class="vaccine-info">${vaccine.disease} - ${vaccine.dose}</span>`;
                
                // Thêm chú thích nếu có
                if (vaccine.note) {
                    vaccineInfo += `<br><span class="vaccine-info">(${vaccine.note})</span>`;
                }
                
                vaccineCell.innerHTML = vaccineInfo;
                row.appendChild(vaccineCell);
                
                // Cột ngày tiêm
                const dateCell = document.createElement('td');
                dateCell.textContent = vaccine.calculatedDate.toLocaleDateString('vi-VN');
                row.appendChild(dateCell);
                
                // Kiểm tra trạng thái
                const statusCell = document.createElement('td');
                
                // Kiểm tra xem vaccine này đã được tiêm chưa
                const matchingVaccine = previousVaccines.find(pv => 
                    pv.name === vaccine.name && 
                    pv.dose === vaccine.dose
                );
                
                // Kiểm tra giới hạn tuổi tiêm cho Viêm gan B sơ sinh
                let isOutOfWindow = false;
                if (vaccine.name === "Viêm gan B sơ sinh" && vaccine.maxAgeDays) {
                    const today = new Date();
                    const ageInDays = Math.floor((today - birthdate) / (1000 * 60 * 60 * 24));
                    if (ageInDays > vaccine.maxAgeDays) {
                        isOutOfWindow = true;
                    }
                }
                
                if (matchingVaccine) {
                    statusCell.textContent = 'Đã tiêm';
                    statusCell.className = 'status-complete';
                } else if (isOutOfWindow) {
                    statusCell.textContent = 'Đã quá thời gian tiêm';
                    statusCell.className = 'status-due';
                    row.appendChild(statusCell);
                    
                    // Thêm một hàng ghi chú
                    const noteRow = document.createElement('tr');
                    const noteCell = document.createElement('td');
                    noteCell.colSpan = 4;
                    noteCell.className = 'alert';
                    noteCell.textContent = 'Lưu ý: Vaccine Viêm gan B sơ sinh chỉ tiêm trong vòng 7 ngày đầu sau sinh.';
                    noteRow.appendChild(noteCell);
                    scheduleBody.appendChild(row);
                    scheduleBody.appendChild(noteRow);
                    return; // Bỏ qua việc thêm hàng thông thường
                } else if (vaccine.calculatedDate <= today) {
                    statusCell.textContent = 'Đến hạn tiêm';
                    statusCell.className = 'status-due';
                } else {
                    // Tính số ngày còn lại
                    const daysLeft = Math.ceil((vaccine.calculatedDate - today) / (1000 * 60 * 60 * 24));
                    statusCell.textContent = `Còn ${daysLeft} ngày`;
                    statusCell.className = 'status-coming';
                }
                
                row.appendChild(statusCell);
                scheduleBody.appendChild(row);
            });
            
            // Hiển thị kết quả
            resultsDiv.style.display = 'block';
        });

        // Hàm tính toán ngày tiêm cho tất cả các vaccine, bao gồm cả vaccine phụ thuộc
        function calculateVaccineDates(vaccines, birthdate, previousVaccines) {
            const processedVaccines = [];
            const vaccineDoseMap = new Map(); // Lưu trữ thông tin về vaccine đã xử lý
            
            // Sao chép mảng để không ảnh hưởng đến dữ liệu gốc
            const vaccinesToProcess = [...vaccines];
            
            // Xử lý tất cả các vaccine thông thường (không phụ thuộc)
            for (const vaccine of vaccinesToProcess) {
                if (!vaccine.isRelativeTiming) {
                    const vaccineData = { ...vaccine };
                    
                    // Tính ngày tiêm dự kiến
                    if (vaccine.ageInDays !== undefined) {
                        // Vaccine tiêm theo ngày sau sinh
                        const calculatedDate = new Date(birthdate);
                        calculatedDate.setDate(birthdate.getDate() + vaccine.ageInDays);
                        vaccineData.calculatedDate = calculatedDate;
                    } else {
                        // Vaccine tiêm theo tháng
                        const calculatedDate = new Date(birthdate);
                        calculatedDate.setMonth(birthdate.getMonth() + vaccine.age);
                        vaccineData.calculatedDate = calculatedDate;
                    }
                    
                    // Lưu thông tin về vaccine đã xử lý
                    const key = `${vaccine.name}-${vaccine.dose}`;
                    vaccineDoseMap.set(key, vaccineData);
                    
                    processedVaccines.push(vaccineData);
                }
            }
            
            // Xử lý các vaccine phụ thuộc (sau khi tất cả các vaccine thông thường đã được tính)
            for (const vaccine of vaccinesToProcess) {
                if (vaccine.isRelativeTiming) {
                    const vaccineData = { ...vaccine };
                    
                    // Tìm vaccine phụ thuộc
                    const dependentKey = `${vaccine.prevVaccine}-${vaccine.prevDose}`;
                    const dependentVaccine = vaccineDoseMap.get(dependentKey);
                    
                    if (dependentVaccine) {
                        // Tính ngày tiêm dựa trên ngày tiêm của vaccine phụ thuộc
                        const dependentDate = dependentVaccine.calculatedDate;
                        const calculatedDate = new Date(dependentDate);
                        calculatedDate.setDate(dependentDate.getDate() + vaccine.daysAfterPrevious);
                        
                        vaccineData.calculatedDate = calculatedDate;
                        
                        // Lưu thông tin về vaccine đã xử lý
                        const key = `${vaccine.name}-${vaccine.dose}`;
                        vaccineDoseMap.set(key, vaccineData);
                        
                        processedVaccines.push(vaccineData);
                    }
                }
            }
            
            // Sắp xếp kết quả theo ngày tiêm
            return processedVaccines.sort((a, b) => a.calculatedDate - b.calculatedDate);
        }
    </script>
</body>
</html>
